<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Dirty Flag</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

        {% if username is none %}
            <link rel="stylesheet" href="{{ url_for('static', filename='css/intro.css') }}">
        {% endif %}
    </head>
    <body>
        <h1>Are you a <br> <span class="outrun">dirty flagger?</span></h1>

        {% if username is none %}
            <div class="main-content">
                {% include 'partials/cta.html' %}
                <p>
                    <a href="{{ url_for('faq') }}">What's a dirty flag?</a>
                </p>
            </div>
        {% else %}
            <div id="dirty-flag-data" class="main-content">
            </div>

            <script type="text/javascript">
                let loadingText = "Loading..."

                function updateLoadingText(text, milliseconds) {
                    return setTimeout(() => {
                        loadingText = text;
                    }, milliseconds)
                }

                const loadingTimeouts = [
                    updateLoadingText("Still loading...", 10_000),
                    updateLoadingText("You must really enjoy online chess, eh?", 20_000),
                    updateLoadingText("How many games have you played!?", 30_000),
                    updateLoadingText("I'm worried about you.", 60_000),
                ]

                async function getDirtyFlagCountStreamedAndSummary() {
                    try {
                        const response = await fetch("{{ url_for('get_dirty_flag_count_streamed') }}");
                        const textDecoder = new TextDecoder("ascii")
                        for await (let chunk of response.body) {
                            // chunk is a Uint8Array. Parse it to a string of characters
                            chunk = textDecoder.decode(chunk).trim();
                            try {
                                const { username, dirty_flags: dirtyFlags } = JSON.parse(chunk);
                                const fontScale = dirtyFlags < 50 ? 1 : (dirtyFlags - 50) * 0.01 + 1;
                                document.getElementById("dirty-flag-data").innerHTML = `
                                    <p>
                                        <span class="outrun">${username}</span>, you've dirty flagged
                                    </p> 
                                    <p>
                                        <span class="outrun" style="font-size: ${fontScale}em">${dirtyFlags}</span> time${dirtyFlags === 1 ? '' : 's'}.
                                    </p>
                                    <p>
                                        ${loadingText}
                                    </p>
                                `
                            } catch (error) {
                                // Ignore errors from parsing the JSON.
                            }
                        }

                        const summaryResponse = await fetch("{{ url_for('get_dirty_flag_summary') }}");
                        if (summaryResponse.status < 400) {
                            document.getElementById("dirty-flag-data").innerHTML = await summaryResponse.text();
                        } else {
                            document.getElementById("dirty-flag-data").innerHTML = `<p>Something went horribly wrong. Sorry!</p>`;
                        }
                    } catch (error) {
                        document.getElementById("dirty-flag-data").innerHTML = `<p>Something went horribly wrong. Sorry! Specifically: ${error.message}</p>`;
                    } finally {
                        for (const timeout of loadingTimeouts) {
                            clearTimeout(timeout);
                        }
                    }
                }

                getDirtyFlagCountStreamedAndSummary();
            </script>
        {% endif %}
    </body>
</html>
